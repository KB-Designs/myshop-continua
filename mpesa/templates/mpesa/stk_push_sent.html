{% extends "shop/base.html" %}

{% block content %}
<div class="max-w-lg mx-auto mt-16 bg-white shadow-lg rounded-lg p-8 text-center">

  <h2 class="text-3xl font-bold text-blue-600 mb-4">ðŸ“² MPESA Payment</h2>
  
  <p class="text-gray-700 mb-2">
    Weâ€™ve sent an M-PESA STK push to 
    <strong class="text-blue-700">{{ order.mpesa_phone }}</strong> 
    for Order <strong>#{{ order.id }}</strong>.
  </p>

  <p class="text-gray-700 mb-2">
    Please check your phone and enter your M-PESA PIN to complete the payment.
  </p>

  <p class="text-gray-500 italic mb-6">
    Waiting for payment confirmation...
  </p>

  <div class="flex justify-center">
    <div class="animate-spin rounded-full h-10 w-10 border-t-4 border-blue-600 border-solid"></div>
  </div>

  <script>
    function checkPaymentStatus() {
      fetch("{% url 'mpesa:payment_status' order.id %}")
        .then(response => response.json())
        .then(data => {
          if (data.status === 'paid') {
            window.location.href = "{% url 'orders:thank_you' order.id %}";
          } else if (data.status === 'failed') {
            window.location.href = "{% url 'mpesa:payment_failed' order.id %}";
          } else {
            setTimeout(checkPaymentStatus, 5000);
          }
        })
        .catch(error => {
          console.error("Error checking payment status:", error);
          setTimeout(checkPaymentStatus, 5000);
        });
    }

    // Start polling after 5 seconds
    setTimeout(checkPaymentStatus, 5000);
  </script>

</div>
{% endblock %}
