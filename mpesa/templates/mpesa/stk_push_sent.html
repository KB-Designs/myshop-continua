{% extends "shop/base.html" %}

{% block content %}
  <h2>MPESA Payment</h2>
  <p>Weâ€™ve sent an M-PESA STK push to <strong>{{ order.mpesa_phone }}</strong> for Order #{{ order.id }}.</p>
  <p>Please check your phone and enter your M-PESA PIN to complete the payment.</p>
  <p>Waiting for payment confirmation...</p>

  <script>
  function checkPaymentStatus() {
    fetch("{% url 'mpesa:payment_status' order.id %}")
      .then(response => response.json())
      .then(data => {
        if (data.status === 'paid') {
          window.location.href = "{% url 'orders:thank_you' order.id %}";
        } else if (data.status === 'failed') {
          window.location.href = "{% url 'mpesa:payment_failed' order.id %}";
        } else {
          setTimeout(checkPaymentStatus, 5000);
        }
      })
      .catch(error => {
        console.error("Error checking payment status:", error);
        setTimeout(checkPaymentStatus, 5000);
      });
  }

  // Start polling
  setTimeout(checkPaymentStatus, 5000);
</script>

{% endblock %}
