{% extends "shop/base.html" %}

{% block title %}
  Thank You
{% endblock %}

{% block content %}
  <h1>Thank You!</h1>
  <p>Your order has been placed successfully.</p>
  <p>Your order number is <strong>#{{ order.id }}</strong>.</p>

  <p>
    If you selected M-Pesa as your payment method, check your phone for an STK push request to complete the payment.
  </p>

  <!-- ‚úÖ Payment status -->
  {% if order.payment_status == 'Paid' %}
    <p style="color: green;">‚úÖ Payment Successful (Receipt: {{ order.payment_reference }})</p>
    <script>
      // Auto-redirect to home after 5 seconds
      setTimeout(() => {
        window.location.href = "{% url 'shop:product_list' %}";
      }, 5000);
    </script>
  {% elif order.payment_status == 'Failed' %}
    <p style="color: red;">‚ùå Payment Failed</p>
  {% else %}
    <p style="color: orange;">‚åõ Payment Pending</p>

    <!-- üîÑ Manual refresh button with spinner -->
    <button id="refresh-btn" onclick="refreshPage()">üîÑ Refresh Payment Status</button>
    
    <div id="spinner" style="display: none; margin-top: 10px;">
      <div class="loader"></div>
      <p>Checking payment status...</p>
    </div>
  {% endif %}

  <p><a href="{% url 'shop:product_list' %}">‚Üê Back to Shopping</a></p>

  <!-- CSS Spinner -->
  <style>
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    button {
      padding: 8px 12px;
      border: none;
      background-color: #3498db;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #2980b9;
    }
  </style>

  <!-- JavaScript -->
  <script>
    function refreshPage() {
      document.getElementById("spinner").style.display = "block";
      document.getElementById("refresh-btn").disabled = true;
      setTimeout(() => {
        location.reload();
      }, 1500); // short delay to show spinner before reload
    }
  </script>
{% endblock %}
